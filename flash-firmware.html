---
layout: default
title: Flash ESP32 Firmware
---

<div class="content">
  <h1>ESP32 Web Flasher</h1>
  <p>Select a port and click the button below to flash your ESP32 firmware:</p>
  <select id="port-selector">
    <option value="" disabled selected>Select a port...</option>
  </select>
  <button id="connect">Connect to ESP32</button>
  <div id="debug">
    <p id="status">Status: Waiting for user interaction...</p>
    <ul id="log"></ul>
  </div>
</div>

<script type="module">
  import { ESPLoader } from 'https://cdn.jsdelivr.net/gh/espressif/esptool-js@latest/dist/web/esploader.js';

  const statusElement = document.getElementById('status');
  const logElement = document.getElementById('log');
  const portSelector = document.getElementById('port-selector');

  const logMessage = (message) => {
    const li = document.createElement('li');
    li.textContent = message;
    logElement.appendChild(li);
  };

  const listSerialPorts = async () => {
    if (!('serial' in navigator)) {
      logMessage('Web Serial API is not supported in this browser.');
      statusElement.textContent = 'Status: Web Serial API is not supported in this browser.';
      return;
    }

    try {
      const ports = await navigator.serial.getPorts();
      portSelector.innerHTML = '<option value="" disabled selected>Select a port...</option>'; // Reset dropdown

      ports.forEach((port, index) => {
        const option = document.createElement('option');
        option.value = index; // Use the index as a reference
        option.textContent = `Port ${index + 1}`;
        portSelector.appendChild(option);
      });

      if (ports.length === 0) {
        logMessage('No ports available. Please connect a device and try again.');
        statusElement.textContent = 'Status: No ports available.';
      } else {
        logMessage(`${ports.length} port(s) detected. Select one.`);
        statusElement.textContent = 'Status: Port(s) detected. Select a port.';
      }
    } catch (error) {
      logMessage(`Error listing ports: ${error.message}`);
      statusElement.textContent = `Status: Error listing ports: ${error.message}`;
    }
  };

  // Populate port list on page load
  document.addEventListener('DOMContentLoaded', listSerialPorts);

  document.getElementById('connect').addEventListener('click', async () => {
    const selectedPortIndex = portSelector.value;
    if (!selectedPortIndex) {
      logMessage('Please select a port before connecting.');
      statusElement.textContent = 'Status: Please select a port.';
      return;
    }

    try {
      const ports = await navigator.serial.getPorts();
      const port = ports[selectedPortIndex];

      logMessage('Port selected. Initializing connection...');
      statusElement.textContent = 'Status: Initializing ESP32 connection...';

      const loader = new ESPLoader(port);
      await loader.initialize();
      logMessage(`Connected to ESP32: ${loader.chipName}`);
      statusElement.textContent = `Status: Connected to ESP32: ${loader.chipName}`;

      // Specify your firmware URL
      const firmwareUrl = '/Meshtastic-Experiments/firmwares/E290_firmware_01-13-25.bin';
      logMessage(`Fetching firmware from ${firmwareUrl}...`);
      statusElement.textContent = `Status: Downloading firmware...`;

      const response = await fetch(firmwareUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch firmware: ${response.statusText}`);
      }
      const firmware = new Uint8Array(await response.arrayBuffer());

      logMessage('Flashing firmware...');
      statusElement.textContent = 'Status: Flashing firmware...';

      await loader.flashData(firmware, 0x1000);

      logMessage('Firmware successfully flashed!');
      statusElement.textContent = 'Status: Firmware successfully flashed!';
    } catch (error) {
      logMessage(`Error: ${error.message}`);
      statusElement.textContent = `Status: Error: ${error.message}`;
      console.error(error);
    }
  });
</script>
