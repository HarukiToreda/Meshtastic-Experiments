---
layout: default
title: ESP32 Web Flasher
---

<div class="content">
  <h1>ESP32 Web Flasher</h1>
  <p>Click the button below to flash your ESP32 device.</p>
  <button id="select-port">Select Port</button>
  <button id="flash-firmware" disabled>Flash Firmware</button>
  <p id="status">Status: Waiting for user interaction...</p>
  <div id="log"></div>
</div>

<script type="module">
  import { ESPLoader } from 'https://cdn.jsdelivr.net/gh/espressif/esptool-js@latest/dist/web/esploader.js';

  let port;
  let loader;

  const statusElement = document.getElementById('status');
  const logElement = document.getElementById('log');

  const logMessage = (message) => {
    const p = document.createElement('p');
    p.textContent = message;
    logElement.appendChild(p);
  };

  document.getElementById('select-port').addEventListener('click', async () => {
    console.log('Select Port button clicked');
    const statusElement = document.getElementById('status');
    statusElement.textContent = 'Select Port button clicked...'; // Debug status update
    try {
      const port = await navigator.serial.requestPort();
      console.log('Port selected:', port);
      statusElement.textContent = 'Port successfully selected!';
    } catch (error) {
      console.error('Error selecting port:', error);
      statusElement.textContent = `Error selecting port: ${error.message}`;
    }
  });


  document.getElementById('flash-firmware').addEventListener('click', async () => {
    try {
      if (!loader) {
        throw new Error('ESP32 not initialized.');
      }

      statusElement.textContent = 'Downloading firmware...';
      const firmwareUrl = '/Meshtastic-Experiments/firmwares/E290_firmware_01-13-25.bin';
      const response = await fetch(firmwareUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch firmware: ${response.statusText}`);
      }
      const firmware = new Uint8Array(await response.arrayBuffer());

      statusElement.textContent = 'Flashing firmware...';
      await loader.flashData(firmware, 0x1000);
      statusElement.textContent = 'Firmware successfully flashed!';
      logMessage('Firmware successfully flashed!');
    } catch (error) {
      statusElement.textContent = `Error: ${error.message}`;
      logMessage(`Error: ${error.message}`);
    }
  });
</script>
