<script type="module">
  import { ESPLoader } from 'https://cdn.jsdelivr.net/gh/espressif/esptool-js@latest/dist/web/esploader.js';

  document.getElementById('connect').addEventListener('click', async () => {
    const status = document.getElementById('status');
    try {
      status.textContent = 'Requesting port...';
      if (!('serial' in navigator)) {
        throw new Error('Web Serial API not supported in this browser.');
      }

      const port = await navigator.serial.requestPort();
      status.textContent = 'Initializing ESP32 connection...';
      const loader = new ESPLoader(port);
      await loader.initialize();
      status.textContent = `Connected to ESP32: ${loader.chipName}`;

      // Specify your firmware URL
      const firmwareUrl = '/Meshtastic-Experiments/firmwares/E290_firmware_01-13-25.bin';
      status.textContent = `Downloading firmware from ${firmwareUrl}...`;
      const response = await fetch(firmwareUrl);
      if (!response.ok) {
        throw new Error(`Failed to fetch firmware: ${response.statusText}`);
      }
      const firmware = new Uint8Array(await response.arrayBuffer());

      status.textContent = 'Flashing firmware...';
      await loader.flashData(firmware, 0x1000);
      status.textContent = 'Firmware successfully flashed!';
    } catch (error) {
      status.textContent = `Error: ${error.message}`;
      console.error(error);
    }
  });
</script>
